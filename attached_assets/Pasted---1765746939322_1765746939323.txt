Сейчас “не генерируется отчёт”. Нужна точная диагностика и фикс.

Включи подробные логи на сервере для цепочки:

POST /api/audits

GET /api/audits/:id

GET /api/audits/:id/pdf

POST /api/public/express-check

Проверь, что именно “не генерируется”:
A) Аудит не создаётся в БД? (нет записи audits)
B) Аудит создаётся, но report.checks пустой/ошибка runAudit?
C) PDF не скачивается? (generatePdfReport падает)

Добавь временные лог-строки (потом уберёшь):

перед вызовом runAudit/runExpressAudit

после получения report (log: scorePercent, checks.length)

перед сохранением в БД

перед вызовом generatePdfReport

в catch печатай err.stack

После этого:

воспроизведи 2 сценария:

curl -X POST /api/public/express-check ...

curl -X POST /api/audits ... (авторизовано)

затем GET /api/audits/{id}/pdf

Покажи мне реальные логи и точку падения.

Исправление:

Если падение из-за новых полей (evidence/rknCheck/evidenceBundle) → синхронизируй shared/schema.ts и сериализацию в routes, чтобы API/DB не ломались.

Если падение из-за PDF (AI-блок/поля) → сделай pdf-генератор tolerant: любые новые поля optional и не обязательны.

Сделай commit: "Fix report generation regression (audit + express + pdf)"

Как правильно внедрить РКН и “запросить ИНН/наименование” в обоих сервисах
У вас два сервиса, значит два UX/контракта:

1) Express (публичный) — POST /api/public/express-check
Правильно так:

Express не должен требовать реквизиты сразу, чтобы не ломать конверсию.

Он должен вернуть:

needsCompanyDetails: true, если не найден ИНН/наименование,

и companyDetailsRequest (какие поля просим).

На UI показать bottom sheet/диалог: “Для точной проверки РКН введите Наименование и ИНН (опционально)”.

Если пользователь вводит → второй запрос: POST /api/public/express-check повторно, но уже с companyDetails.​

2) Полный аудит (личный кабинет) — POST /api/audits
Здесь можно строже:

Если пакет НЕ express_report и реквизиты не найдены:

показать форму “Наименование юрлица и ИНН” как шаг после первичного скана,

сохранить companyDetails вместе с аудитом (чтобы PDF/договор/повторный прогон использовали их).

Единый механизм RKN (в коде)
В audit-engine.ts делаем extractCompanyDetailsFromPages(pages) → {inn?, name?, ogrn?, ...}

Затем buildRknCheck({ extracted, manual }):

если inn есть → confidence=high

если только name → confidence=low

если ничего → needsCompanyDetails=true

Важно: один и тот же buildRknCheck() должен вызываться и в runExpressAudit, и в runAudit, иначе получится “в одном сервисе есть, в другом нет”.​

Точный текст требования “если не удаётся вытащить реквизиты”
Поля, которые нужно запросить минимум:

Наименование юрлица/ИП (строка)

ИНН (10/12 цифр)

И предупреждение при отказе:

“Без ИНН поиск в реестре РКН будет менее точным (возможны совпадения по названию)”. (Реестр — официальный источник, и поиск по ИНН действительно надёжнее.)​

Чтобы не гадать: “не генерируется отчёт” — это не создаётся запись аудита, или PDF не скачивается, или UI не показывает результат? Напиши одно предложение: где именно ломается (после кнопки “Проверить” что происходит).