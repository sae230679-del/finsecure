

FINAL PROMPT FOR REPLIT AGENT (HARD / ONE PASS)
0) HARD RULES (NO EXCEPTIONS)
Do NOT claim “done/works” without artifacts: SQL output, curl responses, screenshots, and YooKassa debug JSON files.​

Do NOT hardcode any prices, package types, or service names in frontend/backend validation; all must come from DB (audit_packages).​

Payments: client must never send price/amount; server computes strictly by auditId → audit.packageType → audit_packages.price.​

If package not found / inactive / price<=0 → return HTTP 400 and do NOT create a YooKassa payment.​

packageType validation must NOT be z.enum([...]). It must be DB-backed existence check.​

All new admin debug/test endpoints must be superadmin-only (requireSuperAdmin).​

1) CANONICAL NAMING (FIX FOREVER)
We have 2 services and canonical packageType keys:

Service 1: Express check
Free “Short express report” shown immediately on screen after check.

Paid product: “Full express PDF report”.

DB key: audit_packages.type = "expressreport" (exactly this string).​

Service 2: Full site audit (paid)
Paid full audit; price depends on site type.

Universal package: audit_packages.type = "other" (exactly this string).​

Other types: landing, ecommerce, medical, children, etc. (admin-managed).​

2) DATABASE: ENSURE PACKAGES EXIST (AUTO-SEED)
Implement storage.ensureDefaultPackages() called on app startup (near ensureSuperAdmin boot).​

Requirements
Only INSERT missing records; NEVER overwrite existing admin edits (price/name/description).

Ensure at least these packages exist (create if missing):

expressreport: name "Экспресс‑отчёт (полный PDF)", price 900, is_active true

other: name "Другое / Универсальный", price 15900, is_active true

landing, ecommerce, medical, children: reasonable default name/price/is_active true

If schema has fields like criteria_count/features, set sane defaults.

Artifact required:

SQL output after boot:
SELECT type,name,price,is_active FROM audit_packages ORDER BY type;

3) ADMIN UX REFACTOR (GROUP BY SERVICES + SYSTEM SETTINGS)
Rebuild admin navigation and pages to remove confusion.

3.1 Top-level admin groups
A) “УСЛУГИ (продукт и цены)”
Subsections:

Услуга 1 — Экспресс‑проверка

Card “Краткий отчёт (бесплатно)” (text/help settings only, no price)

Card “Полный отчёт (PDF) — платно”
-> Edit ONLY package type="expressreport": name/description/price/is_active/(criteria_count/features)

Услуга 2 — Полный аудит сайта

Table of packages where type != "expressreport" with CRUD (create new type, edit fields)

Disable instead of delete: only toggle is_active.

B) “СИСТЕМНЫЕ НАСТРОЙКИ (платформа)”
Subsections:

Платежи / YooKassa (superadmin-only for secrets)

ИИ (ai mode + API keys status)

Email / SMTP

Сайт / Контакты / Тексты

Пользователи и доступ (if exists)

3.2 Data model for system settings
Use existing systemsettings (key-value) or implement if missing.​

Store secrets in systemsettings (encrypted if you already have approach; otherwise at least do not expose in UI once saved—show masked).

Never log secrets.

Artifacts:

Screenshot of new admin navigation showing both top-level groups and subsections.

4) PUBLIC PACKAGES API (UI PRICES ALWAYS FROM DB)
Implement:
GET /api/public/packages

returns array of { type, name, description, price, is_active, service }

service mapping:

if type=="expressreport" -> "express_pdf"

else -> "full_audit"

supports filters:

?service=express_pdf|full_audit

?type=...

Frontend must use this endpoint for:

Express “Buy full report” price (expressreport).

Full audit site-type selector list and displayed price cards.

No hardcoded prices in UI.

5) REMOVE “INVALID PACKAGE TYPE” FOREVER (DB-DRIVEN VALIDATION)
5.1 POST /api/audits (Full audit create)
body: { websiteUrl, packageType }

validate:

package exists in audit_packages

is_active==true

packageType != "expressreport" (service2 only)

if “Не знаю/выбрать все” in UI:

must send packageType="other" (and it is guaranteed by seeding)

Artifact:

curl:
curl -X POST .../api/audits -d '{"websiteUrl":"https://example.com","packageType":"other"}'
must return 200 with auditId.

6) EXPRESS FLOW: FREE SHORT REPORT + PAID PDF
6.1 POST /api/public/express-check
After request completes, the UI must immediately show the short report on screen (no payment needed):

url

scorePercent + severity

passed/warning/failed/total

list of checks (>=7) with name/status/details

RKN/INN block (see section 8)

6.2 Buy “Full express PDF report”
Use endpoint (existing or create):
POST /api/express-report/purchase (requireAuth)

body: { token }

creates audit with:

packageType="expressreport"

status="pending_payment"

returns { auditId }
Then UI calls /api/payments/create.

Also fix labels:

Must say “Оплата за полный отчет (экспресс‑проверка)”

Must NOT say “покупка пакета” for this flow.

7) YOOKASSA PAYMENT: AMOUNT + DESCRIPTION ALWAYS CORRECT, NO 0 RUB
7.1 POST /api/payments/create
Body: { auditId:number, paymentMethod:"sbp"|"bank_card"|... }

Server steps:

find audit by id

pkg = find audit_packages by type=audit.packageType

if !pkg or !pkg.is_active or pkg.price<=0 -> 400 and stop

amount.value = ${pkg.price}.00, currency="RUB"

description:

if pkg.type=="expressreport":
"Оплата за полный отчет (экспресс-проверка)"

else:
"Оплата за полный аудит сайта: ${pkg.name}"

Create YooKassa payment, return confirmationUrl.

7.2 Fix SBP 400 “Authentication type is not allowed”
For paymentMethod="sbp":

DO NOT send authentication_type at all.

Do not include card-specific fields in SBP payload.

7.3 Mandatory debug files (temporary)
Write these files on every attempt (no secrets):

debug/yookassa-last-payload.json

debug/yookassa-last-response.json

Artifacts:

Provide those files for a failed and for a successful attempt.

8) RKN/INN CHECK: MUST WORK IN 4 CASES
RKN check must be implemented and surfaced in:

Express short report screen

Express full PDF

Full audit result screen

Full audit PDF

8.1 UX for INN
Try auto-detect INN (if implemented).

If not found: open modal to enter INN manually (10 or 12 digits) OR “Skip”.

Save result as rknCheck object with:

status: "ok"|"not_found"|"skipped"|"failed"

inn: string|null

source: "auto"|"manual"

checkedAt: ISO

raw: optional json

Cache 24h in rkn_registry_cache (inn unique, last_checked_at, raw_data jsonb, is_registered boolean).

8.2 API endpoints
POST /api/public/rkn/check (or similar) to check given INN with caching.

Ensure both express and full flows store rknCheck into the audit/publicAudit result and expose it in GET endpoints used by UI/PDF.

Artifacts:

SQL showing cached row reused within 24h.

9) PDF: CYRILLIC MUST RENDER ON IPHONE
Use a TTF/OTF font that supports Cyrillic (e.g., DejaVuSans.ttf).

Ensure PDF generator selects that font for all text.

Add smoke text line in PDF: “Проверка кириллицы: Привет”.

Artifacts:

Provide generated PDF + iPhone screenshot (Files/Preview) showing readable Cyrillic.

10) SYSTEM SETTINGS → PAYMENTS → “TEST CONNECTION” BUTTON (SUPERADMIN ONLY)
Add in admin page “Платежи / YooKassa” a button “Проверить соединение”.

10.1 Backend endpoint (superadmin only)
POST /api/admin/yookassa/test-connection (requireSuperAdmin)​
Logic:

Verify shopId/secretKey configured.

Create YooKassa payment for 10.00 RUB with description:
"SecureLex: test connection (10 RUB)"

Immediately call YooKassa cancel on created paymentId (do not open payment form).

Return { ok:true, createdPaymentId, canceled:true } or { ok:false, step:"create"|"cancel", error }.

Persist last test result in systemsettings:

yookassa_last_test_at

yookassa_last_test_ok

yookassa_last_test_message

yookassa_last_test_payment_id

10.2 UI requirements
Show last test status/time/message.

Never display secretKey once saved (mask it).

Artifacts:

Screenshot of admin page showing OK result and last test time.

11) ACCEPTANCE CHECKLIST (MUST PROVIDE PROOF)
Change price in admin for expressreport (e.g., 900→901) -> UI express buy button updates AND YooKassa shows 901 (not 0).

Change price in admin for other -> full audit UI updates AND YooKassa shows new price.

Full audit no longer returns Invalid package type.

SBP payment no longer throws 400 “Authentication type is not allowed”.

Provide debug files debug/yookassa-last-*.json.

RKN present in 4 contexts (2 screens + 2 PDFs).

Provide list of changed files + endpoints + migrations.

END.

SQL по audit_packages

debug/yookassa-last-payload.json и debug/yookassa-last-response.json

2 curl (создание полного аудита + создание платежа)
— без этого не принимать работу.

