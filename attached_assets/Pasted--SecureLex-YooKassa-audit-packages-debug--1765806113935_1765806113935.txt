Продолжаем проект SecureLex. Сейчас уже есть YooKassa, связка с audit_packages и debug‑логирование. Нужно:

Добавить Robokassa как второй провайдер.

Включить/поддержать рассрочку/оплату долями и в YooKassa, и в Robokassa.

Сделать единый UX с баннером “Оплатите в рассрочку / долями”.

Починить ЛК на iPhone (последние отчёты не сохраняются/не видны у обычных пользователей).

Добиться рабочей оплаты тестового PDF (990 ₽) без ошибки ЮKassa.

Проверить и починить конфигурационный токен/параметры для виджета YooKassa на фронте.

Все пункты обязательны. Нужны живые артефакты, а не только описание кода.

0. Жёсткие правила
Никаких “по идее работает”. Для каждого пункта приложить:

фрагменты кода (без секретов),

curl‑примеры,

содержимое debug‑файлов,

скрины UI.

Не ломать уже рабочую YooKassa‑схему: цены и пакеты по‑прежнему только из БД (audit_packages).

Никаких секретных ключей/паролей в фронте, логах и репорте.

Если сторонний сервис (YooKassa/Robokassa) возвращает ошибку — нужно:

показать полный JSON ответа,

пояснить, что именно не так (credentials, тариф, способ оплаты и т.п.),

предложить рабочий вариант (например, карты вместо SBP, если СБП не доступен).​

1. Robokassa: настройки + интеграция
1.1. Настройки в БД / systemsettings
Добавить в systemsettings (или аналог) ключи:

robokassa_enabled (bool, default false)

robokassa_merchant_login (string)

robokassa_password1 (string, секрет)

robokassa_password2 (string, секрет)

robokassa_is_test (bool)

robokassa_description_template (string, можно {packageName})

Секреты:

При чтении для админки возвращать только маску (например, ****), если значение уже задано.

Не логировать пароли ни в каких логах.​

1.2. Админка: вкладка “Robokassa”
В разделе “СИСТЕМНЫЕ НАСТРОЙКИ → Платежи”:

Добавить отдельную вкладку/секцию “Robokassa” (как у YooKassa).

Показывать только superadmin.

Форма:

Toggle “Включить Robokassa” → robokassa_enabled.

Input “Merchant Login” → robokassa_merchant_login.

Password inputs “Пароль #1” и “Пароль #2” → соответствующие ключи (после сохранения показывать только маску).

Checkbox “Тестовый режим” → robokassa_is_test.

Textarea “Описание платежа (шаблон)” → robokassa_description_template.

API:

Расширить текущий эндпоинт системных настроек, чтобы эти ключи сохранялись и читались.

1.3. Бэкенд: создание платежа Robokassa
Новый эндпоинт:

POST /api/payments/create-robokassa (requireAuth):

Вход: { auditId: number }

Действия:

Найти audit по auditId (принадлежит текущему пользователю).

Найти pkg по audit.packageType в audit_packages, проверить is_active и цену > 0.

Расчитать сумму как pkg.price.

Считать настройки Robokassa из systemsettings:

если robokassa_enabled=false или нет логина/паролей — вернуть 400 с понятной ошибкой.

Сформировать URL Robokassa по их протоколу: login, outSum, invId, SignatureValue и пр. (тестовый/боевой режим в зависимости от robokassa_is_test).​

Вернуть JSON: { paymentUrl: "https://auth.robokassa.ru/..." }.

Webhook/callback:

Добавить обработчик (GET/POST) /api/payments/robokassa/callback:

Проверять подпись по password2.

На успешную оплату:

помечать связанный заказ/аудит как “paid/completed” по аналогии с YooKassa webhook.

2. Рассрочка / оплата долями (YooKassa + Robokassa)
2.1. Общие настройки
Добавить ключи в systemsettings:

installments_yookassa_enabled (bool)

installments_robokassa_enabled (bool)

installments_banner_title (string)

installments_banner_text (string)

В админке (Payments):

Вкладка YooKassa:

Чекбокс “Предлагать оплату в рассрочку через YooKassa (если поддерживается тарифом)”.

Вкладка Robokassa:

Чекбокс “Предлагать оплату в рассрочку через Robokassa (если поддерживается тарифом)”.

Поля баннера/модалки:

Title + Text (общие для обоих провайдеров).

2.2. YooKassa: не блокировать и при наличии — использовать рассрочку
Проверить текущую интеграцию:

Если используется redirect/виджет YooKassa, не ограничивать набор способов оплаты так, чтобы расcрочка пропадала.​

Если тариф/аккаунт позволяет явно указать метод рассрочки:

Добавить отдельный режим: “Рассрочка YooKassa”, где при создании платежа:

либо выставляется соответствующий payment_method_data.type,

либо используется подходящий widget/flow, где пользователь может выбрать рассрочку сам.​

3. UX: баннер “Оплатите в рассрочку / долями”
Фронтенд (экспресс‑PDF и полный аудит):

Если включена хотя бы одна рассрочка (installments_yookassa_enabled или installments_robokassa_enabled):

Рядом с основной кнопкой “Оплатить” показывать баннер/плашку:

Заголовок/текст: из installments_banner_title + installments_banner_text.

Кнопка “Оплатить в рассрочку / долями”.

При клике:

Открывать модалку с выбором:

“Рассрочка YooKassa” (если включена и YooKassa активна).

“Рассрочка Robokassa” (если включена и Robokassa активна).

При выборе:

“YooKassa” → запускать текущий YooKassa flow (с учётом настроек рассрочки).

“Robokassa” → вызывать POST /api/payments/create-robokassa и редиректить на paymentUrl.

Важно:

Основной сценарий “оплатить сразу” через YooKassa должен остаться как есть, рассрочка — дополнительная опция.

4. Баг: Личный кабинет на iPhone (отчёты не сохраняются/не видны)
Суть бага:

На iPhone (Safari/WebKit) в ЛК:

последние отчёты/аудиты не отображаются для обычных пользователей, даже после успешного завершения.

Superadmin видит, а простой пользователь — нет (или исчезают при перезагрузке).

Задача:

Проанализировать фронтенд ЛК:

Найти компоненты, которые отображают список аудитов/отчётов.

Проверить, не завязаны ли они на localStorage, sessionStorage или нестабильные cookies.​

На iOS localStorage/cookies могут очищаться или работать неустойчиво → ЛК должен полагаться только на бэкенд‑API для списка отчётов.

Исправить:

Список аудитов/отчётов в ЛК должен загружаться из API (например, /api/audits для текущего юзера), а не из localStorage.

Если есть кэширование на клиенте — оно должно быть дополнительным, но не единственным источником правды.

Любые ошибки при чтении/записи localStorage на iOS должны перехватываться и не ломать ЛК.

Артефакты:

Список изменённых файлов фронтенда.

Скрин/видос с iPhone/эмулятора (или хотя бы devtools с мобильным user‑agent), где видно:

пользователь логинится,

запускает аудит,

новый отчёт появляется в списке и остаётся видимым после перезагрузки.

5. YooKassa: исправить ошибку при оплате тестового PDF (990 ₽)
Сейчас:

При попытке оплатить PDF за 990 ₽ появляется ошибка “со стороны YooKassa” (401/invalid_credentials или Authentication type is not allowed).​

Задача:

Включить детальную диагностику:

Убедиться, что при каждом запросе платежа:

debug/yookassa-last-payload.json и debug/yookassa-last-response.json перезаписываются последними значениями.

В админке (YooKassa) добавить блок:

“Последняя ошибка YooKassa” с:

HTTP‑кодом,

code,

description.

Проверить настройки:

shopId, secretKey, test/production режим — должны соответствовать реальному магазину из кабинета YooKassa.

Сверить текущие значения с актуальными в личном кабинете YooKassa.​

Исправить:

Если ошибка invalid_credentials → это строго ошибка логина/ключа/режима:

привести настройки в systemsettings/env к тем, что даны YooKassa (включая testMode/boevoy).

Если снова Authentication type is not allowed:

убедиться, что:

для payment_method_data.type="sbp" не передаётся authentication_type и другие card‑specific поля (вы уже чистили — перепроверить);

если ваш договор не поддерживает СБП, отключить SBP в UI и использовать только карты/универсальный метод.​

Добиться успешного кейса:

Настроить такой метод (например, карта) и провайдер (YooKassa в нужном режиме), при котором:

POST /api/payments/create для PDF 990 ₽ возвращает 200 с валидным confirmation_url.

В debug/yookassa-last-response.json нет 4xx/5xx, а есть нормальный объект платежа в статусе pending/waiting_for_capture и т.п.

Показать:

curl‑запрос на создание платежа,

содержимое двух debug‑файлов для успешного кейса.

6. Проверка конфигурационного токена/параметров для виджета YooKassa (фронт)
Нужно убедиться, что фронт правильно инициализирует виджет YooKassa:

Найти компонент, который инициализирует виджет/redirect YooKassa (любые вызовы YooMoneyCheckoutWidget, yookassa-widget и т.п.).​

Проверить, какие параметры туда уходят:

shopId / merchant_id,

amount, currency,

paymentToken / confirmationToken (если используется server‑side),

тестовый/боевой режим.

Сопоставить с бэкендом и настройками:

shopId должен приходить из настроек (через API/конфиг), а не быть жёстко захардкожен.

Если используется токен/confirmation, убедиться, что он:

реально создаётся на сервере,

не устарел к моменту использования.​

Добавить обработку ошибок:

Логировать ошибки инициализации виджета (в консоль и при необходимости в backend) с текстом и кодом.​

Убедиться, что в браузер консоли нет ошибок вида “invalid token”, “invalid shopId” и т.п.

7. Что предоставить в финальном отчёте
Работа считается завершённой только после того, как ты приложишь:

Скрины админки:

Payments: YooKassa (с флагами рассрочки и последней ошибкой),

Payments: Robokassa (настройки и флаг рассрочки).

Примеры платежей:

curl + ответ POST /api/payments/create (YooKassa, успешный кейс, PDF 990 ₽ или любой пакет).

curl + ответ POST /api/payments/create-robokassa (валидный paymentUrl).

Актуальные debug/yookassa-last-payload.json и ...-response.json для успешного платежа.

UX:

Скрин страницы оплаты с баннером “Оплатите в рассрочку / долями” и модалкой выбора (YooKassa/Robokassa).

ЛК iPhone:

Скрин/описание, что на iPhone:

пользователь логинится,

запускает аудит,

новый отчёт появляется в списке и не пропадает после обновления страницы.

Список изменённых файлов:

backend файлы (routes, storage, настройки, Robokassa, YooKassa),

frontend файлы (компоненты оплаты, ЛК, баннер рассрочки).

Сначала распиши краткий план реализации по этим пунктам, затем приступай к изменениям. Когда всё будет готово — приложи финальный отчёт со всеми артефактами (curl, debug‑файлы, скрины, список файлов).