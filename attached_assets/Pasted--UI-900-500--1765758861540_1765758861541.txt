В UI при покупке “Полный отчёт 900 ₽” приходит 500 “Ошибка при создании отчета”.

Блок “Проверка реестра РКН” показывает “ИНН найден… требуется проверка”, но фактической проверки нет.

PDF либо не генерится, либо кириллица в PDF отображается некорректно (особенно на iPhone).

Главные цели (Definition of Done)
Платный PDF‑отчет работает без 500: создаётся платеж/заказ, после оплаты доступен PDF, до оплаты — закрыт.

РКН реестр операторов ПДн по ИНН реализован через неофициальный парсинг публичной страницы pd.rkn.gov.ru с кэшем и дисклеймером “данные из открытых источников”.​

UX выбора ИНН реализован и в экспресс‑проверке, и в полном аудите:

если ИНН не найден → модалка: ввод ИНН + чекбокс “Продолжить без проверки по ИНН”

если пользователь пропускает → дисклеймер “информация без ИНН может быть неточной (возможно потребуется дополнительное уточнение)”

Кириллица в PDF отображается корректно на iPhone (iOS viewer), Android и десктопах: шрифты реально встроены в PDF (embedded).​

Часть A — СРОЧНО: исправить 500 при покупке PDF
Найди, какой фронтовый action вызывается при клике “Купить за 900 ₽” (Network → request URL).

В backend найди этот endpoint и воспроизведи 500 локально.

Вставь в ответ:

HTTP статус и response body

stacktrace (последние 50 строк логов)

Исправь первопричину и докажи:

повторный клик → HTTP 200

возвращается confirmationUrl YooKassa (или аналог) и есть запись в БД order/payment

больше нет “Ошибка при создании отчета”.

Важно: цена всегда берётся из БД/админки (audit_packages.priceRub как integer RUB), без хардкода.​

Часть B — РКН по ИНН: парсинг pd.rkn.gov.ru + кэш + UX (ОБА СЕРВИСА)
B1) Единый контракт rknCheck
Ввести единый объект rknCheck в результатах:

status: "checked" | "not_checked" | "failed"

used: "inn_found" | "manual_inn" | "skipped" | "none"

query: { inn?: string, companyName?: string }

result: { found: boolean, itemsCount?: number, registryUrl: string, matchedBy: "inn" | "name" | "unknown" } | null

confidence: "high" | "medium" | "low" | "none"

needsCompanyDetails: boolean

details: string (обязательно содержит “данные из открытых источников”)

B2) DevTools discovery: найти реальный запрос формы
Обязательный шаг для точности:

Открыть https://pd.rkn.gov.ru/operators-registry/operators-list/.​

DevTools → Network:

Preserve log

фильтр Fetch/XHR

Ввести тестовый ИНН в форму и нажать поиск.

Зафиксировать реальный request:

method (GET/POST)

URL

параметры (inn / name / page / csrf если есть)

тип ответа (HTML/JSON)

B3) Реализация парсера (точность = cheerio)
Если endpoint отдаёт JSON → использовать JSON напрямую.

Если отдаёт HTML → парсить HTML через cheerio (разрешено добавить зависимость).​

Regex для HTML не использовать (кроме извлечения CSRF при необходимости).​

Минимально надёжный критерий “found”:

нашли хотя бы 1 строку результата/карточку

либо обнаружили текст/элемент “ничего не найдено” (если он есть)

Всегда возвращать registryUrl (чтобы можно было воспроизвести вручную).

B4) Кэш и лимиты (обязательно)
Создать таблицу rkn_registry_cache:

id, inn, companyName, responseJson, status, fetchedAt, ttlSeconds
TTL: 86400 (24ч) минимум, можно 7 дней.

Лимит запросов к pd.rkn.gov.ru:

semaphore 1–2 параллельных запроса

rps 1 req/sec

timeout 10–15 сек

При ошибках/403/непонятной разметке:

rknCheck.status="failed"

details="Не удалось получить данные из открытых источников (РКН)"

аудит/покупка/PDF НЕ падают.

B5) UX: ИНН найден / не найден (обязательно)
Если ИНН найден автоматически:

used="inn_found"

запускаем проверку сразу (в экспрессе тоже, но через кэш)

показываем результат в UI блоке.

Если ИНН не найден:

показываем модалку:

текст “Для получения сведений из реестра операторов РКН необходим ваш ИНН”

поле ИНН

поле “Наименование” (опционально)

чекбокс “Продолжить без проверки по ИНН”

если пользователь ввёл ИНН → used="manual_inn" и запускаем проверку

если skip → used="skipped", status="not_checked", confidence="low", дисклеймер “информация без ИНН может быть неточной…”

B6) Где внедрить (оба сервиса)
Экспресс: POST /api/public/express-check и получение результата по token — всегда возвращать rknCheck.​

Полный аудит: POST /api/audits — сохранять rknCheck в audit_results.rkn_check_json и возвращать в GET /api/audits/:id.​

Часть C — PDF: кириллица и iPhone (ОБЯЗАТЕЛЬНО)
C1) Жёсткое требование
В PDF должны быть встроены шрифты с кириллицей (embedded), иначе iOS viewer часто показывает квадраты/пустоту. PDFKit это поддерживает через TTF/OTF.​

C2) Что сделать в коде PDF (pdf-generator)
Использовать TTF/OTF (НЕ woff/woff2) и регистрировать их в PDFKit.​

Явно задать шрифт для всего текста и убедиться, что используются стили Regular/Bold одной семьи.

Добавить smoke‑тест:

генерим PDF с тестовой строкой: “Проверка кириллицы: Привет, ИНН 7707083893”

открываем на iPhone (Files/Preview) и убеждаемся, что текст читается.

C3) Диагностика “почему сейчас ломается”
В проекте уже упоминаются Roboto-Regular/Roboto-Bold в PDF‑коде — проверить:

что файлы шрифтов реально существуют в server/fonts (или где лежат)

что это .ttf

что пути корректны в production сборке (Docker/VPS) и файлы попадают в image (проверить Dockerfile COPY fonts).​

Если шрифт не найден или формат не поддержан — PDFKit может тихо уйти в стандартный font без кириллицы или упасть; исправить так, чтобы всегда использовался embeddable font.​

Часть D — Приёмка (строго)
Показать 6 доказательств:

D1) Платёж/отчет
До оплаты: GET /api/audits/:id/pdf → 402/403

После оплаты: GET /api/audits/:id/pdf → 200

D2) RKN сценарии (экспресс + полный)
A) ИНН найден автоматически → rknCheck.used="inn_found", status="checked"
B) ИНН введён вручную → used="manual_inn", status="checked"
C) Skip → used="skipped", status="not_checked" + дисклеймер

D3) PDF кириллица
Файл PDF открывается на iPhone и кириллица читается.
(Опционально) В свойствах PDF видно, что шрифт embedded.
В конце приложить список изменённых файлов и миграций.
Важные запреты
Никаких хардкодов цен (900 и т.д.) — только audit_packages.priceRub.
Нельзя, чтобы сбой РКН ломал аудит/покупку/PDF: только rknCheck.status="failed"